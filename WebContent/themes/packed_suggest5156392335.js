(function(d,h,b){var g="searchSuggest",j=".item",e={"9":"tab","27":"esc","38":"up","40":"down","13":"enter"};var i=h.document,f=h,c={url:"",tmplEngine:"",tmplPanel:"",tmplItem:"",queryArg:""},k={preventSearch:function(l){if(l===""){return true}return false},parse:function(l){return l},delay:300,dataType:"json",highlighter:function(l){var m=this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return l.replace(new RegExp("("+m+")","ig"),function(n,o){return"<strong>"+o+"</strong>"})},form:"",onSelect:function(m,l){l.submit()},autoFindForm:false};d.extend(c,k);var a=function(m,l){this.el=m;this.$el=d(this.el);this.options=d.extend({},c,l);this.initalize(l)};d.extend(a.prototype,{initalize:function(){this.$el.attr({autocomplete:"off",dir:"ltr"});this.preventSearch=this.options.preventSearch;this.template=this.options.tmplEngine;this.parse=this.options.parse;this.highlighter=this.options.highlighter;if(this.options.autoFindForm){var l=this.$el.closest("form");if(l.length){this.form=l}}else{this.form=this.options.form}this.listen()},listen:function(){this.$el.on("input propertychange",d.proxy(this.input,this)).on("keyup",d.proxy(this.keyup,this)).on("keypress",d.proxy(this.keypress,this)).on("blur",d.proxy(this.blur,this)).on("beforedeactivate",d.proxy(function(){if(this.isOverSuggestion){return false}},this)).on("focus",d.proxy(this.focus,this));if(d.browser.chrome||d.browser.webkit||d.browser.msie){this.$el.on("keydown",d.proxy(this.keydown,this))}},focus:function(l){this.isOverSuggestion=false;this.isFocused=true;this.manualLookup()},manualLookup:function(){var l=this.val();if(l.length){if(this.preventSearch(l)){return}this.lookup(this.val())}},blur:function(l){if(this.isOverSuggestion){l.preventDefault();return}this.hide();this.isFocused=false},keyup:function(l){l.stopPropagation();l.preventDefault()},keydown:function(l){this.suppressKeyPressRepeat=!~d.inArray(l.keyCode,[40,38,9,13,27]);this.move(l)},keypress:function(l){if(this.suppressKeyPressRepeat){return}this.move(l)},move:function(l){if(!this.shown){return}switch(e[l.keyCode]){case"tab":case"esc":l.preventDefault();break;case"up":l.preventDefault();this.prev();break;case"down":l.preventDefault();this.next();break;case"enter":l.preventDefault();this.select();break}l.stopPropagation()},input:function(m){if(!this.isFocused){return}if(m.type==="propertychange"&&this.propertychangeSilent){this.propertychangeSilent=false;return}var l=this.val();if(this.delay){clearTimeout(this.delay);delete this.delay}if(this.preventSearch(l)){if(this.shown){this.hide()}return}this.delay=setTimeout(d.proxy(function(){this.lookup(l)},this),this.options.delay)},val:function(l){if(!l){return this.$el.val()}this.propertychangeSilent=true;this.$el.val(l)},select:function(){var l=this.getPanel(),n=l.find(".active"),m=n.text();this.val(m);this.hide();if(this.options.onSelect){this.options.onSelect(m,this.form)}},next:function(){var l=this.getPanel(),n=l.find(".active");if(!n.length){l.find(j).first().toggleClass("active");return}var m=n.next();n.removeClass("active");if(m.length){m.addClass("active")}},prev:function(){var l=this.getPanel(),n=l.find(".active");if(!n.length){l.find(j).last().toggleClass("active");return}var m=n.prev();n.removeClass("active");if(m.length){m.addClass("active")}},render:function(m){this.renderQuery=this.query;var l=this.getPanel();l.empty();d.each(m,d.proxy(function(n,o){l.append(this.template(this.options.tmplItem,{item:this.highlighter(o)}))},this));return this},renderShow:function(){var l=this.getPanel(),m=l.find(".active");if(m.length){m.removeClass("active")}this.show()},show:function(){var l=this.getPanel(),m=d.extend({},this.$el.offset(),{height:this.el.offsetHeight});l.css({top:m.top+m.height-1,left:m.left});l.show();this.shown=true;return this},hide:function(){this.getPanel().hide();this.shown=false},mouseenterItem:function(o){var n=d(o.currentTarget),l=this.getPanel(),m=l.find(".active");if(m.length){m.removeClass("active")}n.toggleClass("active")},clickItem:function(l){l.preventDefault();this.select()},getPanel:function(){if(this.panel_singleton){return this.panel_singleton}this.panel_singleton=d(this.options.tmplPanel);var l=this.panel_singleton;d("body").append(l);l.on("mouseenter",j,d.proxy(this.mouseenterItem,this));l.on("click",j,d.proxy(this.clickItem,this));l.on("dragstart mousedown",j,function(n){n.preventDefault()});var m=this;l.hover(function(){m.isOverSuggestion=true},function(){m.isOverSuggestion=false});return l},lookup:function(m){if(this.jqXhr){this.jqXhr.abort()}this.query=m;var l={};if(this.renderQuery===this.query){this.renderShow();return}l[this.options.queryArg]=this.query;this.jqXhr=d.get(this.options.url,l,d.proxy(this.lookupSuccess,this),this.options.dataType)},lookupSuccess:function(l){l=this.parse(l);if(l){return this.render(l).show()}return this.hide()}});d.fn[g]=function(l){return this.each(function(){if(!d.data(this,"plugin_"+g)){d.data(this,"plugin_"+g,new a(this,l))}})}})(jQuery,window);